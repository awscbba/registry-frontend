---
import Layout from '../../layouts/Layout.astro';
import ProjectSubscriptionForm from '../../components/ProjectSubscriptionForm';

// Generate static paths for all active projects
// Helper function to convert project name to URL-friendly slug
function nameToSlug(name: string): string {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
    .replace(/\s+/g, '-') // Replace spaces with hyphens
    .replace(/-+/g, '-') // Replace multiple hyphens with single
    .trim();
}

// Mapping function to get consistent slugs for known projects
function getProjectSlug(project: any): string {
  const name = project.name.toLowerCase();
  
  // Map known projects to their expected slugs
  if (name.includes('aws workshop')) {
    return 'aws-workshop-2025';
  } else if (name.includes('serverless bootcamp')) {
    return 'serverless-bootcamp';
  } else if (name.includes('testproy') || name.includes('test')) {
    return 'cloud-fundamentals'; // Map test project to cloud-fundamentals
  }
  
  // Fallback to generated slug
  return nameToSlug(project.name);
}

export async function getStaticPaths() {
  try {
    // Fetch active projects from the API at build time
    const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod';
    const response = await fetch(`${API_BASE_URL}/projects`);
    
    if (response.ok) {
      const data = await response.json();
      // Handle both array format and object format
      const projects = Array.isArray(data) ? data : data.projects || [];
      
      // Generate paths for active projects only
      const paths = projects
        .filter((project: any) => project.status === 'active')
        .map((project: any) => ({
          params: { projectId: getProjectSlug(project) }
        }));
      
      console.log(`Generated ${paths.length} static paths for project subscriptions`);
      return paths;
    } else {
      console.warn('Failed to fetch projects for static generation, using fallback paths');
    }
  } catch (error) {
    console.warn('Error fetching projects for static generation:', error);
  }
  
  // Fallback paths if API is not available at build time
  return [
    { params: { projectId: 'aws-workshop-2025' } },
    { params: { projectId: 'cloud-fundamentals' } },
    { params: { projectId: 'serverless-bootcamp' } },
  ];
}

const { projectId } = Astro.params;

if (!projectId) {
  return Astro.redirect('/');
}
---

<Layout title="SuscripciÃ³n al Proyecto - AWS User Group Cochabamba">
	<ProjectSubscriptionForm client:load projectId={projectId} />
</Layout>
