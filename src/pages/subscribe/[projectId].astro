---
import Layout from '../../layouts/Layout.astro';
import ProjectSubscriptionForm from '../../components/ProjectSubscriptionForm';

// Generate static paths for all projects

export async function getStaticPaths() {
  // Helper function to convert project name to URL-friendly slug
  function nameToSlug(name: string): string {
    return name
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
      .replace(/\s+/g, '-') // Replace spaces with hyphens
      .replace(/-+/g, '-') // Replace multiple hyphens with single
      .trim();
  }

  // Mapping function to get consistent slugs for known projects
  function getProjectSlug(project: any): string {
    const name = project.name.toLowerCase();
    
    // Map known projects to their expected slugs
    if (name.includes('aws workshop')) {
      return 'aws-workshop-2025';
    } else if (name.includes('serverless bootcamp')) {
      return 'serverless-bootcamp';
    } else if (name.includes('testproy') || name.includes('test')) {
      return 'cloud-fundamentals'; // Map test project to cloud-fundamentals
    }
    
    // Fallback to generated slug
    return nameToSlug(project.name);
  }

  try {
    // Fetch projects from the API at build time
    const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod';
    const response = await fetch(`${API_BASE_URL}/v2/projects`);
    
    if (response.ok) {
      const data = await response.json();
      // Handle v2 API format, legacy object format, and array format
      const projects = (data && data.data && Array.isArray(data.data)) ? data.data : 
                      (Array.isArray(data) ? data : data.projects || []);
      
      // Projects found for static generation - using structured logging
      const projectSummary = projects.map(p => ({ name: p.name, status: p.status, slug: getProjectSlug(p) }));
      
      // Generate paths for ALL projects (not just active ones) to avoid 404s
      const paths = projects.map((project: any) => ({
        params: { projectId: getProjectSlug(project) },
        props: { project }
      }));
      
      // Static generation completed - structured logging would be used here in runtime
      return paths;
    } else {
      // Failed to fetch projects for static generation, using fallback paths
    }
  } catch (error) {
    // Error fetching projects for static generation - would use structured logging in runtime
  }
  
  // Fallback paths if API is not available at build time
  return [
    { params: { projectId: 'aws-workshop-2025' }, props: { project: null } },
    { params: { projectId: 'cloud-fundamentals' }, props: { project: null } },
    { params: { projectId: 'serverless-bootcamp' }, props: { project: null } },
  ];
}

const { projectId } = Astro.params;
const { project } = Astro.props;

if (!projectId) {
  return Astro.redirect('/');
}
---

<Layout title={`Suscribirse - ${projectId}`}>
	<ProjectSubscriptionForm client:load projectId={projectId} project={project} />
</Layout>
