Name: Frontend_CD_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  BuildProduction:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "ğŸ—ï¸ Production Build"
            echo "=================="
            
            # Install Node.js 18.20.8 specifically for Astro compatibility
            echo "ğŸ“¦ Installing Node.js 18.20.8..."
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs-18.20.8 || sudo yum install -y nodejs
            
            # Verify installation
            echo "âœ… Node.js version: $(node --version)"
            echo "âœ… npm version: $(npm --version)"
            
            # Install Just task runner
            echo "ğŸ“¦ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            echo "âœ… Just version: $(just --version)"
            
            # Build for production
            echo "ğŸ” Running production build pipeline..."
            just ci-validate
            echo ""
            echo "Production build completed"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: productionBuild
          Files:
            - "dist/**/*"

  QualityGate:
    Identifier: aws/build@v1
    DependsOn:
      - BuildProduction
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "ğŸ”’ Production Quality Gate"
            echo "========================="
            
            # Install Node.js 18.20.8 specifically for Astro compatibility
            echo "ğŸ“¦ Installing Node.js 18.20.8..."
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs-18.20.8 || sudo yum install -y nodejs
            
            # Install Just task runner
            echo "ğŸ“¦ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            echo "âœ… Just version: $(just --version)"
            
            # Run quality checks for production
            echo "ğŸ” Running production quality gate..."
            just ci-quality
            echo ""
            echo "Quality gate passed - ready for deployment"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03

  DeployProduction:
    Identifier: aws/build@v1
    DependsOn:
      - QualityGate
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - productionBuild
    Configuration:
      Steps:
        - Run: |
            echo "ğŸš€ Production Deployment"
            echo "======================="
            
            # Install Node.js 18.20.8 specifically for Astro compatibility
            echo "ğŸ“¦ Installing Node.js 18.20.8..."
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs-18.20.8 || sudo yum install -y nodejs
            
            # Install Just task runner
            echo "ğŸ“¦ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            echo "âœ… Just version: $(just --version)"
            
            echo "ğŸ“Š Deployment information:"
            echo "  Environment: Production"
            echo "  Target: S3 + CloudFront"
            echo "  Bucket: people-register-frontend-142728997126-us-east-1"
            echo "  CloudFront: EE5UBCBLMKK9R"
            echo ""
            
            echo "ğŸ¯ Main branch detected - proceeding with production deployment"
            just ci-deploy s3
            echo ""
            echo "ğŸŒ Production URLs:"
            echo "  Frontend: https://d28z2il3z2vmpc.cloudfront.net"
            echo "  API: https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod"
            echo ""
            echo "ğŸ‰ Production deployment completed successfully!"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03

  PostDeploymentValidation:
    Identifier: aws/build@v1
    DependsOn:
      - DeployProduction
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "âœ… Post-Deployment Validation"
            echo "============================"
            
            # Basic health checks
            echo "ğŸ” Checking frontend availability..."
            if curl -f -s https://d28z2il3z2vmpc.cloudfront.net > /dev/null; then
                echo "âœ… Frontend is accessible"
            else
                echo "âŒ Frontend health check failed"
                exit 1
            fi
            
            echo "ğŸ” Checking API availability..."
            if curl -f -s https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod/health > /dev/null; then
                echo "âœ… API is accessible"
            else
                echo "âš ï¸ API health check failed (may be expected if no health endpoint)"
            fi
            
            echo ""
            echo "ğŸ¯ Deployment validation completed"
            echo "ğŸŒ Production system is live and accessible"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03