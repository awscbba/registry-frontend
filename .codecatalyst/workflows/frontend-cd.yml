Name: Frontend_CD_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  BuildProduction:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "ğŸ—ï¸ Production Build"
            echo "=================="
            
            # Install Node.js 20 for Astro 5.12.9 compatibility
            echo "ğŸ“¦ Installing Node.js 20 via NVM..."
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
            
            # Verify installation
            echo "âœ… Node.js version: $(node --version)"
            echo "âœ… npm version: $(npm --version)"
            
            # Install Just task runner
            echo "ğŸ“¦ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            echo "âœ… Just version: $(just --version)"
            
            # Build for production
            echo "ğŸ” Running production build pipeline..."
            just ci-validate
            echo ""
            echo "Production build completed"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: productionBuild
          Files:
            - "dist/**/*"

  QualityGate:
    Identifier: aws/build@v1
    DependsOn:
      - BuildProduction
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "ğŸ”’ Production Quality Gate"
            echo "========================="
            
            # Install Node.js 20 for Astro 5.12.9 compatibility
            echo "ğŸ“¦ Installing Node.js 20 via NVM..."
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
            
            # Verify installation
            echo "âœ… Node.js version: $(node --version)"
            echo "âœ… npm version: $(npm --version)"
            
            # Install Just task runner
            echo "ğŸ“¦ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            echo "âœ… Just version: $(just --version)"
            
            # Run quality checks for production
            echo "ğŸ” Running production quality gate..."
            just ci-quality
            echo ""
            echo "Quality gate passed - ready for deployment"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03

  DeployProduction:
    Identifier: aws/build@v1
    DependsOn:
      - QualityGate
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - productionBuild
    Configuration:
      Steps:
        - Run: |
            echo "ğŸš€ Production Deployment"
            echo "======================="
            
            # Install Node.js 20 for Astro 5.12.9 compatibility
            echo "ğŸ“¦ Installing Node.js 20 via NVM..."
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
            
            # Verify installation
            echo "âœ… Node.js version: $(node --version)"
            echo "âœ… npm version: $(npm --version)"
            
            # Install Just task runner
            echo "ğŸ“¦ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            echo "âœ… Just version: $(just --version)"
            
            echo "ğŸ“Š Deployment information:"
            echo "  Environment: Production"
            echo "  Target: AWS Amplify (SSR)"
            echo "  App ID: d2df6u91uqaaay"
            echo "  Deployment type: Server-Side Rendering"
            echo ""
            
            echo "ğŸ¯ Main branch detected - proceeding with Amplify SSR deployment"
            just ci-deploy amplify d2df6u91uqaaay
            echo ""
            echo "ğŸŒ Production URLs:"
            echo "  Amplify Console: https://console.aws.amazon.com/amplify/home#/d2df6u91uqaaay"
            echo "  Amplify App: https://main.d2df6u91uqaaay.amplifyapp.com"
            echo "  API: https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod"
            echo ""
            echo "âœ… Post-Deployment Validation"
            echo "============================"
            
            # Basic health checks
            echo "ğŸ” Checking API availability..."
            if curl -f -s https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod/health > /dev/null; then
            echo "âœ… API is accessible"
            else
            echo "âš ï¸ API health check failed (may be expected if no health endpoint)"
            fi
            
            echo "ğŸ” Checking Amplify deployment..."
            echo "ğŸ“‹ Amplify App: https://main.d2df6u91uqaaay.amplifyapp.com"
            echo "ğŸ“‹ Monitor deployment in Amplify Console"
            
            echo ""
            echo "ğŸ¯ Deployment validation completed"
            echo "ğŸŒ Amplify SSR deployment initiated successfully"
            echo ""
            echo "ğŸ‰ Amplify SSR deployment completed successfully!"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03

  PostDeploymentValidation:
    Identifier: aws/build@v1
    DependsOn:
      - DeployProduction
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "âœ… Post-Deployment Validation"
            echo "============================"
            
            # Basic health checks
            echo "ğŸ” Checking API availability..."
            if curl -f -s https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod/health > /dev/null; then
                echo "âœ… API is accessible"
            else
                echo "âš ï¸ API health check failed (may be expected if no health endpoint)"
            fi
            
            echo "ğŸ” Checking Amplify deployment..."
            echo "ğŸ“‹ Amplify App: https://main.d2df6u91uqaaay.amplifyapp.com"
            echo "ğŸ“‹ Monitor deployment in Amplify Console"
            
            echo ""
            echo "ğŸ¯ Deployment validation completed"
            echo "ğŸŒ Amplify SSR deployment completed successfully"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03