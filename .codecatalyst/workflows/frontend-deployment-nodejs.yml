Name: Frontend_Deployment_NodeJS
SchemaVersion: "1.0"

# Triggers disabled - using Frontend_Deployment_Pipeline instead
# Triggers:
#   - Type: PUSH
#     Branches:
#       - main
#   - Type: PULLREQUEST
#     Branches:
#       - main
#     Events:
#       - OPEN
#       - REVISION

Actions:
  BuildAndDeploy:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "ğŸš€ Frontend Build & Deploy with Node.js 18"
            echo "=========================================="
            
            # Install Node.js 18.20.8 specifically for Astro compatibility
            echo "ğŸ“¦ Installing Node.js 18.20.8..."
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs-18.20.8 || sudo yum install -y nodejs
            
            # Install Just task runner for robust build process
            echo "ğŸ“¦ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            
            # Verify installations
            echo "âœ… Node.js version: $(node --version)"
            echo "âœ… npm version: $(npm --version)"
            echo "âœ… Just version: $(just --version)"
            
            # Use justfile for robust Node.js setup and build
            echo "ğŸ”§ Running Node.js setup and build with justfile..."
            just ci-validate
            
            # Verify build output
            echo "ğŸ“Š Build verification:"
            if [ -d "dist" ]; then
                echo "âœ… dist/ directory exists"
                echo "ğŸ“ Contents: $(find dist -type f | wc -l) files"
                echo "ğŸ“ Total size: $(du -sh dist | cut -f1)"
                
                # Show some key files
                echo "ğŸ” Key files:"
                find dist -name "*.html" -o -name "*.js" -o -name "*.css" | head -10
            else
                echo "âŒ Build failed - no dist directory found"
                exit 1
            fi
            
            # Deploy to S3
            echo "ğŸš€ Deploying to S3..."
            aws s3 sync dist/ s3://people-register-frontend-142728997126-us-east-1/ --delete --region us-east-1
            
            # Invalidate CloudFront cache
            echo "ğŸ”„ Invalidating CloudFront cache..."
            aws cloudfront create-invalidation \
                --distribution-id EE5UBCBLMKK9R \
                --paths "/*" \
                --region us-east-1
            
            echo ""
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Frontend URL: https://d28z2il3z2vmpc.cloudfront.net"
            echo "ğŸ”§ Admin URL: https://d28z2il3z2vmpc.cloudfront.net/admin"
            
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: frontendBuild
          Files:
            - "dist/**/*"
