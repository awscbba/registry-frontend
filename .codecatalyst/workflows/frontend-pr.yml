Name: Frontend_PR_Analysis
SchemaVersion: "1.0"

Triggers: []
  # - Type: PULLREQUEST
  #   Branches:
  #     - main
  #   Events:
  #     - OPEN
  #     - REVISION

Actions:
  PRAnalysis:
    Identifier: aws/build@v1
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "üìã Pull Request Analysis"
            echo "======================="
            echo "üìÖ Time: $(date)"
            echo "üåø Source Branch: ${CODECATALYST_SOURCE_BRANCH_NAME:-unknown}"
            echo "üéØ Target Branch: ${CODECATALYST_BRANCH_NAME:-main}"
            echo "üè∑Ô∏è Commit: ${CODECATALYST_COMMIT_ID:-unknown}"
            echo "üë§ Author: ${CODECATALYST_COMMIT_AUTHOR:-unknown}"
            echo ""
            
            # Install Node.js 20 using NVM for better compatibility
            echo "üì¶ Installing Node.js 20 via NVM..."
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
            
            # Verify installation
            echo "‚úÖ Node.js version: $(node --version)"
            echo "‚úÖ npm version: $(npm --version)"
            
            # Install Just task runner
            echo "üì¶ Installing Just task runner..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            echo "‚úÖ Just version: $(just --version)"
            echo ""
            
            # Quick build for analysis (don't fail if build issues exist)
            echo "üîç Running quick validation for PR analysis..."
            if just ci-validate; then
                echo "‚úÖ Build validation successful"
                BUILD_STATUS="‚úÖ PASSED"
            else
                echo "‚ö†Ô∏è Build validation had issues"
                BUILD_STATUS="‚ö†Ô∏è ISSUES DETECTED"
                # Create minimal artifacts for analysis
                mkdir -p dist
                echo "<html><body><h1>Build Issues Detected</h1></body></html>" > dist/index.html
            fi
            echo ""
            
            # Run quality checks (don't fail if issues exist)
            echo "üîç Running quality analysis..."
            if just ci-quality; then
                echo "‚úÖ Quality checks successful"
                QUALITY_STATUS="‚úÖ PASSED"
            else
                echo "‚ö†Ô∏è Quality checks had issues"
                QUALITY_STATUS="‚ö†Ô∏è ISSUES DETECTED"
                # Ensure quality files exist for analysis
                [ -f "npm-audit.json" ] || echo '{"vulnerabilities": {}, "metadata": {"note": "analysis failed"}}' > npm-audit.json
                [ -f "npm-outdated.json" ] || echo '{"note": "analysis failed"}' > npm-outdated.json
                [ -f "bundle-size.txt" ] || echo "Bundle size - analysis failed" > bundle-size.txt
            fi
            echo ""
            
            # Generate PR summary
            echo "üìä Generating PR summary..."
            just pr-summary || echo "‚ö†Ô∏è PR summary generation had issues but continuing..."
            echo ""
            
            # Final PR status
            echo "üéØ Pull Request Status Summary:"
            echo "  Build Status: $BUILD_STATUS"
            echo "  Quality Status: $QUALITY_STATUS"
            echo ""
            
            if [[ "$BUILD_STATUS" == *"PASSED"* ]] && [[ "$QUALITY_STATUS" == *"PASSED"* ]]; then
                echo "‚úÖ PR READY FOR REVIEW"
                echo "  All checks passed - safe to merge after review"
            elif [[ "$BUILD_STATUS" == *"PASSED"* ]]; then
                echo "‚ö†Ô∏è PR NEEDS ATTENTION"
                echo "  Build works but quality issues detected"
            else
                echo "‚ùå PR NEEDS FIXES"
                echo "  Build issues must be resolved before merge"
            fi
            echo ""
            
            echo "üìã PR Analysis completed"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03